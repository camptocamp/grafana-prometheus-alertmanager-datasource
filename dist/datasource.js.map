{"version":3,"sources":["../src/datasource.js"],"names":["_","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","severityLevels","jsonData","severity_critical","toLowerCase","severity_high","severity_warning","severity_info","q","options","query","buildQueryParameters","targets","filter","t","hide","length","when","data","labelSelector","parseLabelSelector","encodeURIComponent","replace","expr","scopedVars","showAlertStatus","silenced","inhibited","datasourceRequest","method","headers","then","results","response","columnsDict","getColumnsDict","columns","getColumns","i","row","Array","fill","item","Date","parse","Object","keys","label","annotation","statusAsNumber","getStatusNumber","rows","push","now","text","column","input","map","trim","split","index","labelIndex","selectedLabel","state","statusDict","status","message","title","target","targetss","refId","legendFormat","labels","JSON","stringify","aliasRegex","match","g1"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\n\nexport class GenericDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.severityLevels = {}\n    this.severityLevels[instanceSettings.jsonData.severity_critical.toLowerCase()]  = 4;\n    this.severityLevels[instanceSettings.jsonData.severity_high.toLowerCase()]      = 3;\n    this.severityLevels[instanceSettings.jsonData.severity_warning.toLowerCase()]   = 2;\n    this.severityLevels[instanceSettings.jsonData.severity_info.toLowerCase()]      = 1;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n  }\n\n    query(options) {\n        let query = this.buildQueryParameters(options);\n        query.targets = query.targets.filter(t => !t.hide);\n\n        if (query.targets.length <= 0) {\n            return this.q.when({data: []});\n        }\n        // Format data for table panel\n        if(query.targets[0].type === \"table\"){\n            var labelSelector = this.parseLabelSelector(query.targets[0].labelSelector);\n            let filter = encodeURIComponent(this.templateSrv.replace(query.targets[0].expr, options.scopedVars) || \"\");\n            let showAlertStatus = query.targets[0].silenced || query.targets[0].inhibited;\n\n            return this.backendSrv.datasourceRequest({\n                    url: this.url + '/api/v1/alerts?silenced='+query.targets[0].silenced+'&inhibited='+query.targets[0].inhibited+'&filter='+filter,\n                    data: query,\n                    method: 'GET',\n                    headers: { 'Content-Type': 'application/json' }\n                }).then(response => {\n                    let results = {\n                        \"data\": [{\n                            \"rows\": [],\n                            \"columns\": [],\n                            \"type\": \"table\"\n                            }\n                        ]\n                    };\n\n                if(response.data && response.data.data && response.data.data.length) {\n                    let columnsDict = this.getColumnsDict(response.data.data, labelSelector, showAlertStatus);\n                    results.data[0].columns = this.getColumns(columnsDict);\n\n                    for (let i = 0; i < response.data.data.length; i++) {\n                        let row = new Array(results.data[0].columns.length).fill(\"\");\n                        let item = response.data.data[i];\n                        row[0] = [Date.parse(item['startsAt'])];\n\n                        for (let label of Object.keys(item['labels'])) {\n                            if(label in columnsDict) {\n                                if(label === 'severity') {\n                                    row[columnsDict[label]] = this.severityLevels[item['labels'][label]]\n                                }\n                                else {\n                                    row[columnsDict[label]] = item['labels'][label];\n                                }\n\n                            }\n                        }\n                        for (let annotation of Object.keys(item['annotations'])) {\n                            if(annotation in columnsDict) {\n                                row[columnsDict[annotation]] = item['annotations'][annotation];\n                            }\n                        }\n                        if (showAlertStatus) {\n                          row[columnsDict[\"alert_status\"]] = (query.targets[0].statusAsNumber) ? this.getStatusNumber(item[\"status\"][\"state\"]) : item[\"status\"][\"state\"];\n                        }\n                        results.data[0].rows.push(row);\n                    }\n                }\n                return results;\n            });\n        } else {\n            let filter = encodeURIComponent(this.templateSrv.replace(query.targets[0].expr, options.scopedVars) || \"\");\n                return this.backendSrv.datasourceRequest({\n                url: this.url + '/api/v1/alerts?silenced='+query.targets[0].silenced+'&inhibited='+query.targets[0].inhibited+'&filter='+filter,\n                data: query,\n                method: 'GET',\n                headers: { 'Content-Type': 'application/json' }\n            }).then(response => {\n                return {\n                    \"data\": [{ \"datapoints\": [ [response.data.data.length, Date.now()] ]}]\n                }\n            });\n        }\n    }\n\n    getColumns(columnsDict) {\n        let columns =  [\n          {\n            text: \"Time\",\n            type: \"time\"\n          }\n        ];\n        for(let column of Object.keys(columnsDict)) {\n            columns.push({ text: column, type: \"string\" })\n        }\n        return columns;\n    }\n\n    // Parses the label list into a map\n    parseLabelSelector(input) {\n        var map;\n        if (typeof(input) === \"undefined\" || input.trim().length === 0) {\n            map = [\"*\"];\n        } else {\n            map = input.trim().split(/\\s*,\\s*/);\n        }\n        return map;\n    }\n\n    // Creates a column index dictionary in to assist in data row construction\n    getColumnsDict(data, labelSelector, showAlertStatus) {\n        let index = 1; // 0 is the data column\n        let columnsDict = {};\n        for (let i = 0; i < data.length; i++) {\n            for (let labelIndex = 0; labelIndex < labelSelector.length; labelIndex++) {\n                var selectedLabel = labelSelector[labelIndex];\n                if (selectedLabel === \"*\") {\n                    // '*' maps to all labels/annotations not already added via the label selector list\n                    for (let label of Object.keys(data[i]['labels'])) {\n                        if(!(label in columnsDict) && label !== 'severity') {\n                            columnsDict[label] = index++;\n                        }\n                    }\n                    for (let annotation of Object.keys(data[i]['annotations'])) {\n                        if(!(annotation in columnsDict)) {\n                            columnsDict[annotation] = index++;\n                        }\n                    }\n                } else if (!(selectedLabel in columnsDict)) {\n                    columnsDict[selectedLabel] = index++;\n                }\n            }\n        }\n        if (showAlertStatus) {\n          columnsDict['alert_status'] = index++; \n        }\n        columnsDict['severity'] = index;\n\n        return columnsDict;\n    }\n\n    // getStatusNumber returns a number depending on the alert status\n    getStatusNumber(state) {\n      let statusDict = {\n        \"active\": 0,\n        \"unprocessed\": 1,\n        \"suppressed\": 2,\n      }\n      return statusDict[state];\n    }\n\n    testDatasource() {\n        return this.backendSrv.datasourceRequest({\n            url: this.url + '/api/v1/status',\n            method: 'GET'\n        }).then(response => {\n            if (response.status === 200) {\n                return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\n            }\n        });\n    }\n\n    buildQueryParameters(options) {\n        //remove placeholder targets\n          options.targets = _.filter(options.targets, target => {\n          return target.target !== 'select metric';\n        });\n          options.targetss = _.map(options.targets, target => {\n          return {\n            target: this.templateSrv.replace(target.target),\n            expr: target.expr,\n            refId: target.refId,\n            hide: target.hide,\n            type: target.type || 'single',\n            legendFormat: target.legendFormat || \"\",\n            silenced: target.silenced,\n            inhibited: target.inhibited\n          };\n        });\n        return options;\n      }\n\n    formatInstanceText(labels, legendFormat){\n    if(legendFormat === \"\"){\n      return JSON.stringify(labels);\n    }\n    let aliasRegex = /\\{\\{\\s*(.+?)\\s*\\}\\}/g;\n    return legendFormat.replace(aliasRegex, function(match, g1) {\n      if (labels[g1]) {\n        return labels[g1];\n      }\n      return \"\";\n    });\n  }\n}\n"]}